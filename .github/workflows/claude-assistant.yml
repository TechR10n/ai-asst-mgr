name: Claude AI Assistant

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited, synchronize]
  pull_request_review_comment:
    types: [created, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-assistant:
    runs-on: ubuntu-latest
    # Only run if @claude is mentioned
    if: |
      contains(github.event.issue.body, '@claude') ||
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.pull_request.body, '@claude') ||
      contains(github.event.review.body, '@claude')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install anthropic

      - name: Process Claude mention
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'EOF'
          import os
          import json
          from anthropic import Anthropic

          # Initialize Anthropic client
          client = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])

          # Get event data
          event_name = os.environ['GITHUB_EVENT_NAME']
          with open(os.environ['GITHUB_EVENT_PATH']) as f:
              event = json.load(f)

          # Extract context based on event type
          if event_name == 'issues':
              context_type = 'issue'
              title = event['issue']['title']
              body = event['issue']['body']
              number = event['issue']['number']
              url = event['issue']['html_url']
          elif event_name == 'issue_comment':
              context_type = 'issue_comment'
              title = event['issue']['title']
              body = event['comment']['body']
              number = event['issue']['number']
              url = event['comment']['html_url']
          elif event_name == 'pull_request':
              context_type = 'pull_request'
              title = event['pull_request']['title']
              body = event['pull_request']['body']
              number = event['pull_request']['number']
              url = event['pull_request']['html_url']
          else:
              context_type = 'pr_review_comment'
              title = event['pull_request']['title']
              body = event['comment']['body']
              number = event['pull_request']['number']
              url = event['comment']['html_url']

          # Create prompt for Claude
          prompt = f"""You are a helpful AI assistant integrated into a GitHub repository for the ai-asst-mgr project.

          Context: {context_type}
          Title: {title}
          URL: {url}

          Content:
          {body}

          Please provide a helpful response to the @claude mention. Consider:
          - The project context (vendor-agnostic AI assistant manager)
          - Development standards (95%+ test coverage, mypy --strict, type safety)
          - If asked about implementation, provide concrete code examples
          - If asked about architecture, reference existing patterns
          - Be concise but thorough
          - Use markdown formatting

          Your response:"""

          # Call Claude API
          message = client.messages.create(
              model="claude-sonnet-4-5-20250929",
              max_tokens=2000,
              messages=[{"role": "user", "content": prompt}]
          )

          response = message.content[0].text

          # Post comment via GitHub CLI
          comment_body = f"""{response}

          ---
          ðŸ¤– *Generated by Claude AI Assistant*
          """

          # Save response to file for gh CLI
          with open('/tmp/claude_response.md', 'w') as f:
              f.write(comment_body)

          print(f"Generated response for {context_type} #{number}")
          print(f"Response preview: {response[:200]}...")
          EOF

      - name: Post comment
        run: |
          if [ -f /tmp/claude_response.md ]; then
            # Determine issue or PR number
            if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
              gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/claude_response.md
            else
              gh issue comment ${{ github.event.issue.number }} --body-file /tmp/claude_response.md
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
