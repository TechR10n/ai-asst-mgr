name: Auto Label

# Automatically label PRs and issues based on content
on:
  pull_request:
    types: [opened, edited, synchronize]
  issues:
    types: [opened, edited]

permissions:
  issues: write
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Label based on branch name
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const labels = [];

            // Phase labels
            if (branchName.startsWith('phase-1/')) labels.push('phase-1-foundation');
            if (branchName.startsWith('phase-2/')) labels.push('phase-2-vendors');
            if (branchName.startsWith('phase-2b/')) labels.push('phase-2b-database');
            if (branchName.startsWith('phase-3/')) labels.push('phase-3-cli');
            if (branchName.startsWith('phase-4/')) labels.push('phase-4-audit');
            if (branchName.startsWith('phase-5/')) labels.push('phase-5-coaching');
            if (branchName.startsWith('phase-6/')) labels.push('phase-6-backup');
            if (branchName.startsWith('phase-7/')) labels.push('phase-7-scheduling');
            if (branchName.startsWith('phase-8/')) labels.push('phase-8-capabilities');
            if (branchName.startsWith('phase-9/')) labels.push('phase-9-web-dashboard');
            if (branchName.startsWith('phase-10/')) labels.push('phase-10-testing');

            // Type labels based on branch prefix
            if (branchName.startsWith('fix/')) labels.push('type-bug');
            if (branchName.startsWith('docs/')) labels.push('type-docs');
            if (branchName.startsWith('refactor/')) labels.push('type-refactor');

            // Vendor labels based on branch name
            if (branchName.includes('claude')) labels.push('vendor-claude');
            if (branchName.includes('gemini')) labels.push('vendor-gemini');
            if (branchName.includes('openai') || branchName.includes('codex')) labels.push('vendor-openai');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }

      - name: Label based on title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request?.title || context.payload.issue?.title;
            const labels = [];

            // Type labels from conventional commits
            if (title.startsWith('feat:') || title.startsWith('feat(')) labels.push('type-feature');
            if (title.startsWith('fix:') || title.startsWith('fix(')) labels.push('type-bug');
            if (title.startsWith('docs:') || title.startsWith('docs(')) labels.push('type-docs');
            if (title.startsWith('refactor:') || title.startsWith('refactor(')) labels.push('type-refactor');

            // Priority from title
            if (title.toLowerCase().includes('[high]') || title.toLowerCase().includes('urgent')) {
              labels.push('priority-high');
            } else if (title.toLowerCase().includes('[low]')) {
              labels.push('priority-low');
            }

            const issueNumber = context.payload.pull_request?.number || context.payload.issue?.number;

            if (labels.length > 0 && issueNumber) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: labels
              });
            }

      - name: Auto-assign maintainer to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Auto-assign maintainer as reviewer
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: ['TechR10n']
            });

      - name: Welcome first-time contributor
        if: github.event_name == 'pull_request' || github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if this is their first contribution
            const creator = context.payload.sender.login;

            const { data: contributions } = await github.rest.repos.listContributors({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const isFirstTime = !contributions.some(c => c.login === creator);

            if (isFirstTime) {
              const message = context.payload.pull_request
                ? `ðŸ‘‹ Welcome @${creator}! Thank you for your first contribution to ai-asst-mgr!\n\nThe maintainer (@TechR10n) will review your PR soon. While you wait:\n- Make sure all CI checks pass\n- Review the [contribution guidelines](https://github.com/TechR10n/ai-asst-mgr/blob/main/CONTRIBUTING.md)\n- Join the [discussions](https://github.com/TechR10n/ai-asst-mgr/discussions) if you have questions`
                : `ðŸ‘‹ Welcome @${creator}! Thank you for opening your first issue!\n\nThe maintainer (@TechR10n) will respond soon. To help us address your issue:\n- Make sure you've filled out the issue template completely\n- Provide any relevant logs or error messages\n- Check if a similar issue already exists`;

              const issueNumber = context.payload.pull_request?.number || context.payload.issue?.number;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: message
              });
            }
