{% extends "base.html" %}

{% block title %}Agents - AI Assistant Manager{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Agents</h1>
    <p>Browse AI agents across all vendors</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ data.total_agents }}</div>
        <div class="stat-label">Total Agents</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ data.agents_by_vendor | length }}</div>
        <div class="stat-label">Vendors</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Search & Filter</h2>
    </div>
    <div class="filter-controls">
        <input type="text"
               id="agent-search"
               class="search-input"
               placeholder="Search agents..."
               hx-get="/api/agents"
               hx-trigger="keyup changed delay:300ms"
               hx-target="#agents-container"
               hx-swap="innerHTML"
               hx-include="[name='vendor-filter']">
        <div class="vendor-filters" style="margin-top: 1rem;">
            <label class="filter-checkbox">
                <input type="checkbox" name="vendor-filter" value="all" checked
                       hx-get="/api/agents"
                       hx-target="#agents-container"
                       hx-trigger="change"
                       onclick="toggleAllVendors(this)">
                All Vendors
            </label>
            {% for vendor_id in data.agents_by_vendor.keys() %}
            <label class="filter-checkbox">
                <input type="checkbox" name="vendor-filter" value="{{ vendor_id }}" checked
                       hx-get="/api/agents"
                       hx-target="#agents-container"
                       hx-trigger="change">
                {{ vendor_id | title }}
            </label>
            {% endfor %}
        </div>
    </div>
</div>

<div id="agents-container">
{% for vendor_id, agents in data.agents_by_vendor.items() %}
<div class="card vendor-section" data-vendor="{{ vendor_id }}">
    <div class="card-header">
        <h2 class="card-title">{{ vendor_id | title }}</h2>
        <span class="badge badge-success">{{ agents | length }} agent{% if agents | length != 1 %}s{% endif %}</span>
    </div>

    {% if agents %}
    <div class="agents-grid">
        {% for agent in agents %}
        <div class="agent-card"
             hx-get="/api/agents/{{ vendor_id }}/{{ agent.name | urlencode }}"
             hx-target="#agent-detail-modal"
             hx-swap="innerHTML"
             hx-trigger="click"
             onclick="showModal()">
            <h3>{{ agent.name }}</h3>
            <div class="agent-vendor">{{ agent.vendor }}</div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: var(--text-muted);">No agents configured for this vendor.</p>
    {% endif %}
</div>
{% else %}
<div class="card">
    <p style="color: var(--text-muted);">No vendors installed. Use <code>ai-asst-mgr init</code> to get started.</p>
</div>
{% endfor %}
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Manage Agents</h2>
    </div>
    <p>Use the CLI to manage agents:</p>
    <ul style="margin-top: 1rem; margin-left: 1.5rem;">
        <li><code>ai-asst-mgr agents list</code> - List all agents</li>
        <li><code>ai-asst-mgr agents list --vendor claude</code> - List agents for a specific vendor</li>
        <li><code>ai-asst-mgr agents show &lt;agent-name&gt; --vendor claude</code> - Show agent details</li>
        <li><code>ai-asst-mgr agents create &lt;name&gt; --vendor claude</code> - Create a new agent</li>
    </ul>
</div>

<!-- Agent Detail Modal -->
<div id="agent-modal-backdrop" class="modal-backdrop" onclick="hideModal()" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>Agent Details</h2>
            <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div id="agent-detail-modal">
            <!-- Agent detail will be loaded here via HTMX -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showModal() {
    document.getElementById('agent-modal-backdrop').style.display = 'flex';
}

function hideModal() {
    document.getElementById('agent-modal-backdrop').style.display = 'none';
}

function toggleAllVendors(checkbox) {
    const checkboxes = document.querySelectorAll('input[name="vendor-filter"]');
    checkboxes.forEach(cb => {
        if (cb.value !== 'all') {
            cb.checked = checkbox.checked;
        }
    });
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideModal();
    }
});

// Client-side search filtering (fallback)
document.getElementById('agent-search')?.addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll('.agent-card').forEach(card => {
        const name = card.querySelector('h3').textContent.toLowerCase();
        card.style.display = name.includes(search) ? '' : 'none';
    });
});
</script>
{% endblock %}
